#!/bin/bash
set -e

# 1. Clean up stale server PIDs
rm -f /rails/tmp/pids/server.pid

# 2. Run migrations only if starting the web server
if [ "$1" = "./bin/rails" ] && [ "$2" = "server" ]; then
  echo "Checking database status and running migrations..."
  bundle exec rails db:prepare
fi

# 3. Hand off to the main process
exec "$@"